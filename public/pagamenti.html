<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prosolar Italia • Pagamento rapido</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--overlay:rgba(0,0,0,.45);--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#f39c12;--brand:#0c4372;--ok:#22c55e;--err:#ef4444}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    html,body{height:100%}
    body{margin:0;color:var(--text);background: linear-gradient(var(--overlay),var(--overlay)), url('/prosolar/bg-prosolar.jpg');background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:620px;background:rgba(17,24,39,.85);border-radius:18px;padding:22px;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .header img{height:50px}
    h1{font-size:22px;margin:0;color:var(--brand)}
    p{margin:.25rem 0 0 0;color:var(--muted)}
    label{display:block;font-weight:600;margin:14px 0 6px}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1020;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    .radio{display:flex;gap:10px}
    .btn{cursor:pointer;font-weight:700;border:none}
    .btn-primary{background:var(--accent);color:#1b1205}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.18)}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .footer{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    @media (max-width:560px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <img src="/prosolar/logo.png" alt="Prosolar Italia" onerror="this.style.display='none'">
      <div>
        <h1>Pagamento Prosolar • Klarna / Carta</h1>
        <p>Compila i dati e invia il link su WhatsApp o SMS. (Email facoltativa per la ricevuta.)</p>
      </div>
    </div>

    <form id="payForm" autocomplete="off">
      <label for="nickname">Nickname cliente (per rubrica)</label>
      <input id="nickname" placeholder="Es. MarioRossi" />

      <label for="prodotto">Prodotto / Descrizione</label>
      <input id="prodotto" placeholder="Es. Kit fotovoltaico" required />

      <div class="grid">
        <div>
          <label for="prezzo">Prezzo (€)</label>
          <input id="prezzo" inputmode="decimal" placeholder="Es. 1290,00" required />
        </div>
        <div>
          <label for="telefono">Telefono cliente</label>
          <input id="telefono" placeholder="+39 3331234567" required />
        </div>
      </div>

      <label for="email">Email cliente (opzionale per ricevuta)</label>
      <input id="email" type="email" placeholder="cliente@email.it" />

      <div class="row" style="margin-top:10px">
        <span style="font-weight:600">Invia via:</span>
        <div class="radio" role="radiogroup" aria-label="canale di invio">
          <label><input type="radio" name="canale" value="wa" checked> WhatsApp</label>
          <label><input type="radio" name="canale" value="sms"> SMS</label>
        </div>
      </div>

      <div class="footer">
        <button class="btn btn-primary" type="submit">Invia pagamento</button>
        <button class="btn btn-ghost" type="button" id="copia">Copia link</button>
      </div>
      <div id="esito" class="help" aria-live="polite"></div>
    </form>

    <div class="help">Dopo il pagamento ti sarà inviata una ricevuta via email (se fornita). Ricevute venditore vengono inviate automaticamente all'email Prosolar.</div>
  </div>

  <script>
    // Imposta qui l'API del backend Render (es. https://prosolar-pay.onrender.com)
    const API_BASE = 'https://prosolar-pay.onrender.com';

    const $ = (id) => document.getElementById(id);
    const esito = $("esito");

    // localStorage rubrica automatica
    const LS_KEY = "prosolarClients";
    function saveLocalContact(nick, phone, email){
      if (!nick) return;
      const list = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      const idx = list.findIndex(x => x.nick && x.nick.toLowerCase() === nick.toLowerCase());
      const rec = { nick, phone, email };
      if (idx >= 0) list[idx] = rec; else list.push(rec);
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    function normTelefono(t){
      const s = String(t).replace(/\s+/g,'').replace(/^00/,'+');
      if (/^\d{9,11}$/.test(s) && s.startsWith('3')) return '+39' + s;
      if (/^\d{10,}$/.test(s) && s.startsWith('0')) return '+39' + s;
      return s;
    }

    async function creaCheckout(payload){
      const res = await fetch(`${API_BASE}/api/create-checkout`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); }
      catch { throw new Error('Endpoint non raggiungibile o URL errato. Risposta: ' + raw.slice(0,300)); }
      if (!res.ok) throw new Error(data.error || 'Errore creazione pagamento');
      return data;
    }

    document.getElementById('payForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      esito.textContent = 'Creo link...';
      try {
        const nickname = $("nickname").value.trim();
        const descrizione = $("prodotto").value.trim();
        const importo = $("prezzo").value.trim();
        const telefono = normTelefono($("telefono").value.trim());
        const email = $("email").value.trim() || undefined;
        const canale = document.querySelector('input[name=canale]:checked').value;

        // salva localmente subito
        saveLocalContact(nickname, telefono, email);

        const payload = { descrizione, importoEuro: importo, telefono, email, nickname };
        const { url, sessionId } = await creaCheckout(payload);
        esito.innerHTML = `<span class="ok">Link creato.</span>`;

        const msg = encodeURIComponent(`Ciao! Ti inviamo il link di pagamento PROSOLAR ITALIA per "${descrizione}" (€${importo}). Puoi pagare con Klarna (3 rate) o carta: ${url}`);

        if (canale === 'wa') {
          window.location.href = `https://api.whatsapp.com/send?phone=${encodeURIComponent(telefono)}&text=${msg}`;
        } else {
          window.location.href = `sms:${encodeURIComponent(telefono)}&body=${msg}`;
        }

        // copia link
        $("copia").onclick = async () => {
          try { await navigator.clipboard.writeText(url); esito.innerHTML = '<span class="ok">Link copiato.</span>'; }
          catch { esito.innerHTML = '<span class="err">Impossibile copiare automaticamente.</span>'; }
        };

      } catch (err) {
        console.error(err);
        esito.innerHTML = `<span class="err">${err.message || 'Errore imprevisto'}</span>`;
      }
    });
  </script>
</body>
</html>
